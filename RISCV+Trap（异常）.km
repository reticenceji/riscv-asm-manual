{"root":{"data":{"id":"d3fd07919c76","created":1602936735,"text":"RISCV Trap（异常）","image":"","imageTitle":"","imageSize":"","expandState":"expand","color":"#ffffff"},"children":[{"data":{"id":"c6f5nhft2hs0","created":1602936741984,"text":"同步异常Exception，在指令执行期间产生","layout":null,"color":"#ffffff"},"children":[{"data":{"id":"c6f5p7270s80","created":1602936876121,"text":"M模式下的同步异常","layout":null,"color":"#ffffff"},"children":[{"data":{"id":"c6f5pc12z0w0","created":1602936886938,"text":"访问错误异常 Instruction access fault","layout":null,"color":"#ffffff"},"children":[]},{"data":{"id":"c6f5pfy8tz40","created":1602936895473,"text":"断点异常 Breakpoint","layout":null,"color":"#ffffff"},"children":[]},{"data":{"id":"c6f5pi9q5740","created":1602936900521,"text":"环境调用异常","layout":null,"color":"#ffffff"},"children":[]},{"data":{"id":"c6f5pkjhfco0","created":1602936905465,"text":"非法指令异常 Illegal instruction","layout":null,"color":"#ffffff"},"children":[]},{"data":{"id":"c6f5pmgocao0","created":1602936909648,"text":"非对齐位置异常 Instruction address misaligned","layout":null,"color":"#ffffff"},"children":[]}]}]},{"data":{"id":"c6f5nv7l8340","created":1602936771962,"text":"中断Interruption，由外部设备产生","layout":null,"color":"#ffffff"},"children":[{"data":{"id":"c6f5scl05uw0","created":1602937123235,"text":"三个标准的中断源","layout":null,"color":"#ffffff"},"children":[{"data":{"id":"c6f5sgbt2ag0","created":1602937131386,"text":"软件","layout":null,"color":"#ffffff"},"children":[]},{"data":{"id":"c6f5shqhvxs0","created":1602937134451,"text":"时钟","layout":null,"color":"#ffffff"},"children":[]},{"data":{"id":"c6f5sj42ybk0","created":1602937137449,"text":"外部","layout":null,"color":"#ffffff"},"children":[]}]}]},{"data":{"id":"c6f5vpi8trs0","created":1602937386459,"text":"M模式Trap处理","layout":null,"color":"#ffffff"},"children":[{"data":{"id":"c6q03m9wtpc0","created":1604038239201,"text":"处理流程","color":"#ffffff","layout":null},"children":[{"data":{"id":"c6q05xp6hi00","created":1604038420798,"text":"异常指令的 PC 被保存在 mepc 中，PC 被设置为 mtvec。\n对于Exception，mepc指向导致Trap的指令；对于Interruption，mepc指向中断处理后应该恢复执行的位置。","color":"#ffffff","priority":1,"layout":null},"children":[]},{"data":{"id":"c6q06kdn94o0","created":1604038470166,"text":"根据异常来源设置 mcause，并将 mtval 设置为出错的地址或者其它适用于特定异常的信息字","color":"#ffffff","priority":2,"layout":null},"children":[]},{"data":{"id":"c6q06xg6w800","created":1604038498618,"text":"把控制状态寄存器 mstatus 中的 MIE 位置零以禁用Interrupt，并把先前的 MIE 值保留到 MPIE 中。","color":"#ffffff","priority":3,"layout":null},"children":[]},{"data":{"id":"c6q07l09km00","created":1604038549898,"text":"发生Trap之前的权限模式保留在 mstatus 的 MPP 域中，再把权限模式更改为M。\n如果处理器仅实现 M 模式，则有效地跳过这个步骤）。","color":"#ffffff","priority":4,"layout":null},"children":[]}]},{"data":{"id":"c6f5vto65lk0","created":1602937395524,"text":"相关CSR","layout":null,"color":"#ffffff"},"children":[{"data":{"id":"c6f5vwa3me80","created":1602937401204,"text":"mtvec","layout":null,"color":"#ffffff","font-weight":"bold"},"children":[{"data":{"id":"c6f6pouu6ew0","created":1602939735968,"text":"consisting of a vector base address (BASE) and a vector mode (MODE).","layout":null,"color":"#ffffff"},"children":[{"data":{"id":"c6f6rh188000","created":1602939875669,"text":"MODE==0：Direct All exceptions set pc to BASE.","layout":null,"color":"#ffffff"},"children":[]},{"data":{"id":"c6f6rl1gp940","created":1602939884390,"text":"MODE==1：Vectored Asynchronous interrupts set pc to BASE+4×cause.","layout":null,"color":"#ffffff"},"children":[]}]}]},{"data":{"id":"c6f5w68krj40","created":1602937422879,"text":"mepc","layout":null,"color":"#ffffff","font-weight":"bold"},"children":[{"data":{"id":"c6f5ylt3x0g0","created":1602937613501,"text":"指向发生异常的指令；当异常发生时，异常的PC被保存在mepc。\n就是从Trap中返回的地址。","layout":null,"color":"#ffffff"},"children":[]}]},{"data":{"id":"c6f5w91xfqw0","created":1602937429008,"text":"mcause","layout":null,"color":"#ffffff","font-weight":"bold"},"children":[{"data":{"id":"c6f5zbsob200","created":1602937670071,"text":"表示是发生了Interruption还是Exception，以及发生了什么类型的Interrupt和Exception。\n当Trap发生时，硬件设置mcause。","layout":null,"color":"#ffffff"},"children":[]}]},{"data":{"id":"c6f5wc95zhs0","created":1602937435976,"text":"mie","layout":null,"color":"#ffffff","font-weight":"bold"},"children":[{"data":{"id":"c6f5ww7k0xs0","created":1602937479414,"text":"每个Trap在mie中都有一个enable bit，对应表1。bit为1表示能处理","layout":null,"color":"#ffffff"},"children":[]}]},{"data":{"id":"c6f5wd7fuow0","created":1602937438048,"text":"mip","layout":null,"color":"#ffffff","font-weight":"bold"},"children":[{"data":{"id":"c6f5y3jda680","created":1602937573730,"text":"和mie有相同布局，指示当前待处理的Trap；\n当mip[i]被set 1的时候，如果mie[i]==1, mstatus[mie]==1,那么就产生中断了\n中断处理完成之后，应该手动的将mip的对应位置0","layout":null,"color":"#ffffff"},"children":[]}]},{"data":{"id":"c6f5wk154zc0","created":1602937452905,"text":"mstatus","expandState":"expand","layout":null,"color":"#ffffff","font-weight":"bold"},"children":[{"data":{"id":"c6f6872ml880","created":1602938365066,"text":"MIE，SIE，UIE","layout":null,"color":"#ffffff"},"children":[{"data":{"id":"c6f6a0wa9ts0","created":1602938508350,"text":"Global interrupt-enable bits\n运行在mode x，如果xIE=1，可以Interrupt\nInterrupts for lower-privilege modes, w<x, are always globally disabled.\nInterrupts for higher-privilege modes, y>x, are always globally enabled ","layout":null,"color":"#ffffff"},"children":[]}]},{"data":{"id":"c6f6c97klqo0","created":1602938683175,"text":"SPP，MPP","layout":null,"color":"#ffffff"},"children":[{"data":{"id":"c6f6en6ohnk0","created":1602938870325,"text":"xPP holds the previous privilege mode,The xPP fields can only hold privilege modes up to x,\n也就意味着mret返回到mode MPP , sret返回到mode SPP","layout":null,"color":"#ffffff"},"children":[]}]},{"data":{"id":"c6f6frvslzs0","created":1602938958915,"text":"SPIE，MPIE，UPIE","layout":null,"color":"#ffffff"},"children":[{"data":{"id":"c6f6fu156q80","created":1602938963592,"text":"xPIE holds the value of the interrupt-enable bit active prior to the trap, \n当产生中断的时候，硬件将原先xIE的值放到xPIE，然后将xIE置0。ret指令会把xPIE再写回到xIE","layout":null,"color":"#ffffff"},"children":[]}]},{"data":{"id":"c6f6k2j01jc0","created":1602939295542,"text":"SXL,UXL","layout":null,"color":"#ffffff"},"children":[{"data":{"id":"c6f6k5v8ij40","created":1602939302813,"text":"控制x mode下的XLEN，也意味着riscv32不存在这个东西","layout":null,"color":"#ffffff"},"children":[]}]},{"data":{"id":"c6f6klkjuq80","created":1602939336995,"text":"...","layout":null,"color":"#ffffff"},"children":[]}]},{"data":{"id":"c6f5wi9rnmg0","created":1602937449073,"text":"mtval","layout":null,"color":"#ffffff"},"children":[{"data":{"id":"c6f63mcnr0o0","created":1602938006504,"text":"它保存了陷入（ trap） 的附加信息：地址例外中出错\n的地址、发生非法指令例外的指令本身，对于其他异常，它的值为 0。","layout":null,"color":"#ffffff"},"children":[]}]},{"data":{"id":"c6f5wm02we00","created":1602937457194,"text":"mscratch","layout":null,"color":"#ffffff"},"children":[{"data":{"id":"c6f63qpsmb40","created":1602938016005,"text":"它暂时存放一个字大小的数据。","layout":null,"color":"#ffffff"},"children":[]}]}]}]},{"data":{"id":"c6f5vuy4hw00","created":1602937398303,"text":"S模式Trap处理——委托机制","expandState":"expand","layout":null,"color":"#ffffff"},"children":[{"data":{"id":"c6f6sfg83dk0","created":1602939950586,"text":"所有的trap默认由M mode处理，委托(delegation)是指有选择的将trap交给S mode处理。","layout":null,"color":"#ffffff"},"children":[]},{"data":{"id":"c6f6m49v6600","created":1602939456072,"text":"Machine Trap Delegation Registers ","expandState":"expand","layout":null,"color":"#ffffff"},"children":[{"data":{"id":"c6f6m5sdf6o0","created":1602939459368,"text":"medeleg","layout":null,"color":"#ffffff"},"children":[{"data":{"id":"c6f6v6kg9w00","created":1602940166343,"text":" Machine Expection Delegation，每个位对应表一异常号，为1表示被委托","layout":null,"color":"#ffffff"},"children":[]}]},{"data":{"id":"c6f6mbi3zo80","created":1602939471808,"text":"mideleg","expandState":"expand","layout":null,"color":"#ffffff"},"children":[{"data":{"id":"c6f6v6kg9w00","created":1602940166343,"text":" Machine Interrupt Delegation，每个位对应表一中断号，为1表示被委托","layout":null,"color":"#ffffff"},"children":[]}]}]},{"data":{"id":"c6f6w8hzfds0","created":1602940248911,"text":"Setting a bit in medeleg or mideleg will delegate the corresponding trap, when occurring in S-mode or U-mode, to the S-mode trap handler.\n也就是说无论如何，在x mode发生的异常不会在x以下的mode处理","layout":null,"color":"#ffffff","font-weight":"bold","note":"所"},"children":[]},{"data":{"id":"c6f6ztf2zsg0","created":1602940529541,"text":"S 模式有几个异常处理 CSR： sepc、 stvec、 scause、 sscratch、 stval 和 sstatus，它们执行与 M 模式 CSR 相同的功能。","layout":null,"color":"#ffffff"},"children":[]}]},{"data":{"id":"c6f76zed5880","created":1602941091107,"text":"system_call","layout":null,"color":"#ffffff"},"children":[{"data":{"id":"c6f772c7omw0","created":1602941097508,"text":"注：这部分是我猜的","layout":null,"color":"#ffffff"},"children":[]},{"data":{"id":"c6f7790bczs0","created":1602941112026,"text":"ecall可以产生一个Exception：environment-call-From-X-mode，看起来可以利用这个来完成system_call","layout":null,"color":"#ffffff"},"children":[]}]},{"data":{"id":"c6f7959w9i00","created":1602941260626,"text":"其他指令","layout":null,"color":"#ffffff"},"children":[{"data":{"id":"c6f797e4dew0","created":1602941265235,"text":"mret，sret","layout":null,"color":"#ffffff"},"children":[{"data":{"id":"c6f7a81z7m00","created":1602941345042,"text":"从异常处理函数中返回。\nmret 将 PC 设置为 mepc，通过将 mstatus 的 MPIE 域复制到\nMIE 来恢复之前的中断使能设置，并将权限模式设置为 mstatus 的 MPP 域中的值。\nsret同理","layout":null,"color":"#ffffff"},"children":[]}]},{"data":{"id":"c6f79chzcqo0","created":1602941276353,"text":"wfi","layout":null,"color":"#ffffff"},"children":[{"data":{"id":"c6f79lluc080","created":1602941296177,"text":"wait for interuption","layout":null,"color":"#ffffff"},"children":[]}]},{"data":{"id":"c6f79diiwo00","created":1602941278562,"text":"ecall，ebreak","layout":null,"color":"#ffffff"},"children":[{"data":{"id":"c6f7avvs4pc0","created":1602941396910,"text":"产生Exception，见表1","layout":null,"color":"#ffffff"},"children":[]}]}]}]},"template":"right","theme":"wire","version":"1.4.43"}